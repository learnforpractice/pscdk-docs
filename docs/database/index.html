
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../notify/">
      
      
        <link rel="next" href="../crypto/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.4">
    
    
      
        <title>Database Operations - Python Smart Contracts Development Cook Book</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.240905d7.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  
  <link rel="stylesheet" href="../css/chat-dialog-plugin.css">
</head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#database-operations" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Python Smart Contracts Development Cook Book" class="md-header__button md-logo" aria-label="Python Smart Contracts Development Cook Book" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Python Smart Contracts Development Cook Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Database Operations
            
          </span>
        </div>
      </div>
    </div>
    
    
      <div class="md-header__option">
        <div class="md-select">
          
          <button class="md-header__button md-icon" aria-label="Select language">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24Z"/></svg>
          </button>
          <div class="md-select__inner">
            <ul class="md-select__list">
              
                <li class="md-select__item">
                  <a href="./" hreflang="en" class="md-select__link">
                    English
                  </a>
                </li>
              
                <li class="md-select__item">
                  <a href="../zh/database/" hreflang="zh" class="md-select__link">
                    中文
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/uuosio/pscdk" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Python Smart Contracts Development Cook Book" class="md-nav__button md-logo" aria-label="Python Smart Contracts Development Cook Book" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Python Smart Contracts Development Cook Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/uuosio/pscdk" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../env/" class="md-nav__link">
        Development Environment Setup
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../helloworld/" class="md-nav__link">
        HelloWorld
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../deploy/" class="md-nav__link">
        Deploying a Smart Contract
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../prelude/" class="md-nav__link">
        Prerequisite Knowledge
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../action/" class="md-nav__link">
        Inline Actions
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../notify/" class="md-nav__link">
        The `require_recipient` function
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Database Operations
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Database Operations
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#store" class="md-nav__link">
    Store
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#findupdate" class="md-nav__link">
    find/update
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remove" class="md-nav__link">
    Remove
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lowerboundupperbound" class="md-nav__link">
    Lowerbound/Upperbound
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#querying-the-primary-index-of-a-table-using-api" class="md-nav__link">
    Querying the Primary Index of a Table Using API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operation-of-the-binary-index" class="md-nav__link">
    Operation of the binary index
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#updating-the-binary-index" class="md-nav__link">
    Updating the binary index
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deleting-the-binary-index" class="md-nav__link">
    Deleting the binary index
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-the-api-to-perform-secondary-index-queries-on-a-table" class="md-nav__link">
    Using the API to perform secondary index queries on a table
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-principles-of-the-database" class="md-nav__link">
    Implementation principles of the database
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../crypto/" class="md-nav__link">
        Cryptographic functions
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../common/" class="md-nav__link">
        Common Smart Contract Functions
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../abi/" class="md-nav__link">
        Explanation of ABI types
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../codon/" class="md-nav__link">
        Differences between Codon and standard Python
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#store" class="md-nav__link">
    Store
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#findupdate" class="md-nav__link">
    find/update
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remove" class="md-nav__link">
    Remove
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lowerboundupperbound" class="md-nav__link">
    Lowerbound/Upperbound
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#querying-the-primary-index-of-a-table-using-api" class="md-nav__link">
    Querying the Primary Index of a Table Using API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operation-of-the-binary-index" class="md-nav__link">
    Operation of the binary index
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#updating-the-binary-index" class="md-nav__link">
    Updating the binary index
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deleting-the-binary-index" class="md-nav__link">
    Deleting the binary index
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-the-api-to-perform-secondary-index-queries-on-a-table" class="md-nav__link">
    Using the API to perform secondary index queries on a table
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-principles-of-the-database" class="md-nav__link">
    Implementation principles of the database
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="database-operations">Database Operations</h1>
<p>On-chain data storage and retrieval is a critical feature of smart contracts. EOS implements an in-memory database that allows data to be stored in a table format. Each item in a table has a unique primary index, called a primary key, which is of type <code>u64</code>. The raw data stored in the table can be binary data of any length. When the storage function of a smart contract is called, the data is serialized and stored in the table. When reading, the stored data is deserialized back as a class object. Additionally, EOS supports secondary index tables of types <code>u64</code>, <code>u128</code>, <code>u256</code>, <code>double</code>, and <code>long double</code>, which can be considered special tables with a fixed data length. Primary and secondary index tables can be used together to implement multiple indexes. There can be multiple secondary index tables, and the values in these tables can be repeated, but the primary index in the primary index table must be unique.</p>
<p>The following example demonstrates the usage of EOS's in-memory database.</p>
<h2 id="store">Store</h2>
<p>Storage is the simplest function of the database, and the following code demonstrates this functionality.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># db_example1.codon</span>
<span class="nd">@table</span><span class="p">(</span><span class="s2">&quot;mytable&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">a</span><span class="p">:</span> <span class="n">primary</span><span class="p">[</span><span class="n">u64</span><span class="p">]</span>
    <span class="n">b</span><span class="p">:</span> <span class="nb">str</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">u64</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">primary</span><span class="p">[</span><span class="n">u64</span><span class="p">](</span><span class="n">a</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>

<span class="nd">@contract</span><span class="p">(</span><span class="n">main</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyContract</span><span class="p">(</span><span class="n">Contract</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;teststore&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_store</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;db_test&#39;</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">123</span><span class="n">u64</span><span class="p">,</span> <span class="s1">&#39;hello, world&#39;</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="n">n</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">n</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">n</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Compile:</p>
<div class="highlight"><pre><span></span><code>python-contract build db_example/db_example1.codon
</code></pre></div>
<div class="highlight"><pre><span></span><code>ipyeos<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>-s<span class="w"> </span>-x<span class="w"> </span>test.py<span class="w"> </span>-k<span class="w"> </span>test_store
</code></pre></div>
<p>The test code you are running is as follows:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_store</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">init_db_test</span><span class="p">(</span><span class="s1">&#39;db_example1&#39;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;teststore&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">t</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;++++++++++</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">])</span>
</code></pre></div>
<p><strong>Note</strong>:</p>
<p>In this example, if there is already data with the primary key <code>123u64</code> in the table, an exception will be thrown when the function is called.</p>
<p>To modify the above test case to the following code:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_example1</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">init_db_test</span><span class="p">(</span><span class="s1">&#39;db_example1&#39;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">t</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;++++++++++</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">])</span>

    <span class="c1"># will raise exception</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">t</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
</code></pre></div>
<p>When running the test with the same command, if the <code>push_action</code> is called for the second time, the function will throw an exception similar to the following:</p>
<div class="highlight"><pre><span></span><code>could not insert object, most likely a uniqueness constraint was violated
</code></pre></div>
<p>To avoid such exceptions, the <code>update</code> method must be used when updating data in the table. Before calling <code>store</code>, it is necessary to check whether the primary index already exists in the table. If it does, <code>store</code> method cannot be called, and <code>update</code> method must be used instead. The following example demonstrates how to use it:</p>
<h2 id="findupdate">find/update</h2>
<p>This section demonstrates the lookup and update functionality of the database.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># db_example1.codon</span>

<span class="o">...</span>

<span class="nd">@contract</span><span class="p">(</span><span class="n">main</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyContract</span><span class="p">(</span><span class="n">Contract</span><span class="p">):</span>

<span class="o">...</span>

    <span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;testupdate&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;db_test&#39;</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="n">n</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">n</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="mi">123</span><span class="n">u64</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">it</span><span class="o">.</span><span class="n">is_ok</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+++++update value:&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">n</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+++++store value:&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">n</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
</code></pre></div>
<p>The following is the test code:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_update</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">init_db_test</span><span class="p">(</span><span class="s1">&#39;db_example1&#39;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;testupdate&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;hello, bob&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">t</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;++++++++++</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">])</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;hello, alice&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">t</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
</code></pre></div>
<p>Compile using the following command:</p>
<div class="highlight"><pre><span></span><code>python-contract build db_example/db_example1.codon
</code></pre></div>
<p>Execute the test code with the following command:</p>
<div class="highlight"><pre><span></span><code>ipyeos<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>-s<span class="w"> </span>-x<span class="w"> </span>test.py<span class="w"> </span>-k<span class="w"> </span>test_update
</code></pre></div>
<p>When calling
<div class="highlight"><pre><span></span><code><span class="n">t</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;hello, bob&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
</code></pre></div></p>
<p>it will output:</p>
<div class="highlight"><pre><span></span><code>+++++store value: hello, bob
</code></pre></div>
<p>When calling
<div class="highlight"><pre><span></span><code><span class="n">t</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;hello, alice&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
</code></pre></div></p>
<p>it will output:</p>
<div class="highlight"><pre><span></span><code>+++++update value: hello, alice
</code></pre></div>
<p>As you can see, the above code is a bit complicated. First, it needs to call <code>find</code> to determine whether the value corresponding to the primary index exists, and then decide whether to call <code>store</code> or <code>update</code>. It should be noted that, during the update process, <strong>the value of the primary index cannot be changed</strong>, otherwise an exception will be thrown.</p>
<p>You can try to modify the update code to:</p>
<div class="highlight"><pre><span></span><code><span class="n">item</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="n">key</span><span class="o">+</span><span class="mi">1</span><span class="n">u64</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">n</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
</code></pre></div>
<p>You will see an exception thrown in the smart contract.</p>
<h2 id="remove">Remove</h2>
<p>The following code demonstrates how to remove an item from the database.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># db_example/db_example1.codon</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;testremove&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;test remove&#39;</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">123</span><span class="n">u64</span><span class="p">,</span> <span class="s1">&#39;hello, world&#39;</span><span class="p">)</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="n">n</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">n</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">n</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>

    <span class="n">it</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">123</span><span class="n">u64</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">it</span><span class="o">.</span><span class="n">is_ok</span><span class="p">()</span>
    <span class="n">table</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>

    <span class="n">it</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">123</span><span class="n">u64</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">it</span><span class="o">.</span><span class="n">is_ok</span><span class="p">()</span>
</code></pre></div>
<p>Test code:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_remove</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">init_db_test</span><span class="p">(</span><span class="s1">&#39;db_example1&#39;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;testremove&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">t</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;++++++++++</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">])</span>
</code></pre></div>
<p>Compile using the following command:</p>
<div class="highlight"><pre><span></span><code>python-contract build db_example/db_example1.codon
</code></pre></div>
<p>Test using the following command:</p>
<div class="highlight"><pre><span></span><code>ipyeos<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>-s<span class="w"> </span>-x<span class="w"> </span>test.py<span class="w"> </span>-k<span class="w"> </span>test_remove
</code></pre></div>
<p>The above code first calls the <code>store</code> method to store the data with index <code>123u64</code> in the database, then calls <code>remove</code> to delete it, and uses <code>assert</code> to check the result. If everything is normal, the program will not throw any exceptions.</p>
<h2 id="lowerboundupperbound">Lowerbound/Upperbound</h2>
<p>These two methods are also used to search for elements in the database. Unlike the <code>find</code> method, these two functions are used for fuzzy searching. Among them, the <code>lowerbound</code> method returns an <code>Iterator</code> whose <code>id</code> is <code>&gt;=</code> the specified <code>id</code>, and the <code>upperbound</code> method returns an <code>Iterator</code> whose <code>id</code> is <code>&gt;</code> the specified <code>id</code>. Let's take a look at the usage below:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># db_example/db_example1.codon</span>

<span class="o">...</span>

<span class="nd">@contract</span><span class="p">(</span><span class="n">main</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyContract</span><span class="p">(</span><span class="n">Contract</span><span class="p">):</span>

<span class="o">...</span>

    <span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;testbound&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_bound</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;db_test&#39;</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="n">n</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">n</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">payer</span> <span class="o">=</span> <span class="n">n</span><span class="s1">&#39;hello&#39;</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="n">u64</span><span class="p">,</span> <span class="s2">&quot;alice&quot;</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="n">u64</span><span class="p">,</span> <span class="s2">&quot;bob&quot;</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">5</span><span class="n">u64</span><span class="p">,</span> <span class="s2">&quot;john&quot;</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>

        <span class="n">it</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">lowerbound</span><span class="p">(</span><span class="mi">1</span><span class="n">u64</span><span class="p">)</span>
        <span class="n">value2</span><span class="p">:</span> <span class="n">A</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;+++++:&quot;</span><span class="p">,</span> <span class="n">value2</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">value2</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">value2</span><span class="o">.</span><span class="n">a</span> <span class="o">==</span> <span class="mi">1</span><span class="n">u64</span> <span class="ow">and</span> <span class="n">value2</span><span class="o">.</span><span class="n">b</span> <span class="o">==</span> <span class="s1">&#39;alice&#39;</span>

        <span class="n">it</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">upperbound</span><span class="p">(</span><span class="mi">1</span><span class="n">u64</span><span class="p">)</span>
        <span class="n">value2</span><span class="p">:</span> <span class="n">A</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;+++++:&quot;</span><span class="p">,</span> <span class="n">value2</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">value2</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">value2</span><span class="o">.</span><span class="n">a</span> <span class="o">==</span> <span class="mi">3</span><span class="n">u64</span> <span class="ow">and</span> <span class="n">value2</span><span class="o">.</span><span class="n">b</span> <span class="o">==</span> <span class="s1">&#39;bob&#39;</span>
</code></pre></div>
<p>Test code:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_bound</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">init_db_test</span><span class="p">(</span><span class="s1">&#39;db_example4&#39;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;testbound&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">t</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;++++++++++</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">])</span>
</code></pre></div>
<p>Compile using the following command:</p>
<div class="highlight"><pre><span></span><code>python-contract build db_example/db_example1.codon
</code></pre></div>
<p>Run the test using the following command:</p>
<div class="highlight"><pre><span></span><code>ipyeos<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>-s<span class="w"> </span>-x<span class="w"> </span>test.py<span class="w"> </span>-k<span class="w"> </span>test_bound
</code></pre></div>
<p>Output:</p>
<div class="highlight"><pre><span></span><code>+++++: 1 alice
+++++: 3 bob
</code></pre></div>
<h2 id="querying-the-primary-index-of-a-table-using-api">Querying the Primary Index of a Table Using API</h2>
<p>The above examples are all about how to operate the database table on the chain through the smart contract. In fact, by using the <code>get_table_rows</code> API provided by EOS off the chain, you can also query the table on the chain.</p>
<p>In the test code, the definition of <code>get_table_rows</code> is as follows:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_table_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_json</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span>
                                <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">,</span>
                                <span class="n">limit</span><span class="p">,</span>
                                <span class="n">key_type</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                <span class="n">index_position</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                                <span class="n">reverse</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">show_payer</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Fetch smart contract data from an account. </span>
<span class="sd">    key_type: &quot;i64&quot;|&quot;i128&quot;|&quot;i256&quot;|&quot;float64&quot;|&quot;float128&quot;|&quot;sha256&quot;|&quot;ripemd160&quot;</span>
<span class="sd">    index_position: &quot;2&quot;|&quot;3&quot;|&quot;4&quot;|&quot;5&quot;|&quot;6&quot;|&quot;7&quot;|&quot;8&quot;|&quot;9&quot;|&quot;10&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div>
<p>First of all, to query a table using <code>get_table_rows</code>, the structure of the table must be visible in the ABI description. You can use the following code to describe the table in the corresponding generated ABI file:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># db_example5.codon</span>

<span class="kn">from</span> <span class="nn">chain.database</span> <span class="kn">import</span> <span class="n">primary</span>
<span class="kn">from</span> <span class="nn">chain.contract</span> <span class="kn">import</span> <span class="n">Contract</span>

<span class="nd">@table</span><span class="p">(</span><span class="s2">&quot;mytable&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">a</span><span class="p">:</span> <span class="n">primary</span><span class="p">[</span><span class="n">u64</span><span class="p">]</span>
    <span class="n">b</span><span class="p">:</span> <span class="nb">str</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">u64</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">primary</span><span class="p">[</span><span class="n">u64</span><span class="p">](</span><span class="n">a</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>

<span class="nd">@contract</span><span class="p">(</span><span class="n">main</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyContract</span><span class="p">(</span><span class="n">Contract</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;db_test&#39;</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="n">n</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">n</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">payer</span> <span class="o">=</span> <span class="n">n</span><span class="s1">&#39;hello&#39;</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="n">u64</span><span class="p">,</span> <span class="s2">&quot;alice&quot;</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="n">u64</span><span class="p">,</span> <span class="s2">&quot;bob&quot;</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">5</span><span class="n">u64</span><span class="p">,</span> <span class="s2">&quot;john&quot;</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>

        <span class="n">it</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">lowerbound</span><span class="p">(</span><span class="mi">1</span><span class="n">u64</span><span class="p">)</span>
        <span class="n">value2</span><span class="p">:</span> <span class="n">A</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;+++++:&quot;</span><span class="p">,</span> <span class="n">value2</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">value2</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">value2</span><span class="o">.</span><span class="n">a</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="n">u64</span> <span class="ow">and</span> <span class="n">value2</span><span class="o">.</span><span class="n">b</span> <span class="o">==</span> <span class="s1">&#39;alice&#39;</span>

        <span class="n">it</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">upperbound</span><span class="p">(</span><span class="mi">1</span><span class="n">u64</span><span class="p">)</span>
        <span class="n">value2</span><span class="p">:</span> <span class="n">A</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;+++++:&quot;</span><span class="p">,</span> <span class="n">value2</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">value2</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">value2</span><span class="o">.</span><span class="n">a</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="n">u64</span> <span class="ow">and</span> <span class="n">value2</span><span class="o">.</span><span class="n">b</span> <span class="o">==</span> <span class="s1">&#39;bob&#39;</span>
</code></pre></div>
<p>Here, the <code>table</code> decorator is used to make the compiler include the structure of the table in the ABI.</p>
<p>After adding this <code>table</code> to the class, the compiler will automatically add the <code>get_primary</code> and <code>new_table</code> functions to the class.</p>
<p>At the same time, the member variables of the class must also meet certain requirements: first, a primary index variable must be declared, and the type must be <code>database.primary</code>. The implementation of the <code>primary</code> class is as follows:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">primary</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">T</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">T</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">get_primary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">u64</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">u64</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">get_primary</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__pack__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enc</span><span class="p">:</span> <span class="n">Encoder</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">__pack__</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unpack__</span><span class="p">(</span><span class="n">dec</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">primary</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">primary</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">T</span><span class="o">.</span><span class="n">__unpack__</span><span class="p">(</span><span class="n">dec</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">__size__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">__size__</span><span class="p">()</span>
</code></pre></div>
<p>The <code>primary</code> class is a template class. If the type of the <code>value</code> in <code>primary</code> is not of type <code>u64</code>, then the type must implement the <code>get_primary</code> method. The <code>primary</code> class also has a <code>__call__</code> method to facilitate access to <code>value</code>. In the following discussion of multiple indexes, binary indexes will also be used. The type of the binary index must be <code>database.secondary</code>.</p>
<p>Compilation:
<div class="highlight"><pre><span></span><code>python-contract<span class="w"> </span>build<span class="w"> </span>db_example/db_example5.codon
</code></pre></div></p>
<p>You will see the following description in the generated <code>db_example5.abi:</code>
<div class="highlight"><pre><span></span><code><span class="s2">&quot;tables&quot;</span>:<span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="o">{</span>
<span class="w">            </span><span class="s2">&quot;name&quot;</span>:<span class="w"> </span><span class="s2">&quot;mytable&quot;</span>,
<span class="w">            </span><span class="s2">&quot;type&quot;</span>:<span class="w"> </span><span class="s2">&quot;A&quot;</span>,
<span class="w">            </span><span class="s2">&quot;index_type&quot;</span>:<span class="w"> </span><span class="s2">&quot;i64&quot;</span>,
<span class="w">            </span><span class="s2">&quot;key_names&quot;</span>:<span class="w"> </span><span class="o">[]</span>,
<span class="w">            </span><span class="s2">&quot;key_types&quot;</span>:<span class="w"> </span><span class="o">[]</span>
<span class="w">        </span><span class="o">}</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div></p>
<p>Now consider the test code:
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_example5</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">init_db_test</span><span class="p">(</span><span class="s1">&#39;db_example5&#39;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">t</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;++++++++++</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">])</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get_table_rows</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;mytable&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;++++++=rows: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
</code></pre></div></p>
<p>Run the test:
<div class="highlight"><pre><span></span><code>ipyeos<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>-s<span class="w"> </span>-x<span class="w"> </span>test.py<span class="w"> </span>-k<span class="w"> </span>test_example5
</code></pre></div></p>
<p>Output:
<div class="highlight"><pre><span></span><code>++++++=rows: {&#39;rows&#39;: [{&#39;a&#39;: 1, &#39;b&#39;: &#39;alice&#39;}, {&#39;a&#39;: 3, &#39;b&#39;: &#39;bob&#39;}, {&#39;a&#39;: 5, &#39;b&#39;: &#39;john&#39;}], &#39;more&#39;: False, &#39;next_key&#39;: &#39;&#39;}
</code></pre></div></p>
<h2 id="operation-of-the-binary-index">Operation of the binary index</h2>
<p>First, consider the following example:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># db_example7.codon</span>

<span class="kn">from</span> <span class="nn">chain.contract</span> <span class="kn">import</span> <span class="n">Contract</span>
<span class="kn">from</span> <span class="nn">chain.database</span> <span class="kn">import</span> <span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span>
<span class="kn">from</span> <span class="nn">chain.database</span> <span class="kn">import</span> <span class="n">IdxTable64</span><span class="p">,</span> <span class="n">IdxTable128</span><span class="p">,</span> <span class="n">Iterator</span>
<span class="kn">from</span> <span class="nn">chain.name</span> <span class="kn">import</span> <span class="n">Name</span>

<span class="nd">@table</span><span class="p">(</span><span class="s2">&quot;mytable&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">a</span><span class="p">:</span> <span class="n">database</span><span class="o">.</span><span class="n">primary</span><span class="p">[</span><span class="n">u64</span><span class="p">]</span>
    <span class="n">b</span><span class="p">:</span> <span class="n">secondary</span><span class="p">[</span><span class="n">u64</span><span class="p">]</span>
    <span class="n">c</span><span class="p">:</span> <span class="n">secondary</span><span class="p">[</span><span class="n">u128</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">u64</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">u64</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">u128</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">primary</span><span class="p">[</span><span class="n">u64</span><span class="p">](</span><span class="n">a</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">secondary</span><span class="p">[</span><span class="n">u64</span><span class="p">](</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">secondary</span><span class="p">[</span><span class="n">u128</span><span class="p">](</span><span class="n">c</span><span class="p">)</span>

<span class="nd">@contract</span><span class="p">(</span><span class="n">main</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyContract</span><span class="p">(</span><span class="n">Contract</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">payer</span> <span class="o">=</span> <span class="n">n</span><span class="s2">&quot;hello&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="n">n</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="n">n</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="n">u64</span><span class="p">,</span> <span class="mi">2</span><span class="n">u64</span><span class="p">,</span> <span class="mi">3</span><span class="n">u128</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>

        <span class="n">idx_table_b</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_idx_table_by_b</span><span class="p">()</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">idx_table_b</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">2</span><span class="n">u64</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;++++++it.primary:&quot;</span><span class="p">,</span> <span class="n">it</span><span class="o">.</span><span class="n">primary</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">it</span><span class="o">.</span><span class="n">primary</span> <span class="o">==</span> <span class="mi">1</span><span class="n">u64</span>

        <span class="n">idx_table_c</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_idx_table_by_c</span><span class="p">()</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">idx_table_c</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">3</span><span class="n">u128</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;++++++it.primary:&quot;</span><span class="p">,</span> <span class="n">it</span><span class="o">.</span><span class="n">primary</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">it</span><span class="o">.</span><span class="n">primary</span> <span class="o">==</span> <span class="mi">1</span><span class="n">u64</span>
</code></pre></div>
<p>In this example, two binary indexes are defined:</p>
<div class="highlight"><pre><span></span><code><span class="n">b</span><span class="p">:</span> <span class="n">secondary</span><span class="p">[</span><span class="n">u64</span><span class="p">]</span>
<span class="n">c</span><span class="p">:</span> <span class="n">secondary</span><span class="p">[</span><span class="n">u128</span><span class="p">]</span>
</code></pre></div>
<p>In the code, <code>get_idx_table_by_b</code> and <code>get_idx_table_by_c</code> are used to obtain the tables of the binary indexes, and the returned object types are <code>IdxTable64</code> and <code>IdxTable128</code>, respectively. The tables of binary indexes have similar method names as the tables of the primary index, and can also perform the function of binary index lookup.</p>
<p>Test code:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test.py</span>
<span class="k">def</span> <span class="nf">test_example7</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">init_db_test</span><span class="p">(</span><span class="s1">&#39;db_example7&#39;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">t</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;++++++++++</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">])</span>
</code></pre></div>
<p>Compile:</p>
<div class="highlight"><pre><span></span><code>python-contract build db_example/db_example7.codon
</code></pre></div>
<p>Run the test:</p>
<div class="highlight"><pre><span></span><code>ipyeos<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>-s<span class="w"> </span>-x<span class="w"> </span>test.py<span class="w"> </span>-k<span class="w"> </span>test_example7
</code></pre></div>
<p>Output:
<div class="highlight"><pre><span></span><code>++++++it.primary: 1
++++++it.primary: 1
</code></pre></div></p>
<h2 id="updating-the-binary-index">Updating the binary index</h2>
<p>In practical applications, sometimes it is necessary to update the binary index. Please first look at the following code:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># db_example8.codon</span>
<span class="kn">from</span> <span class="nn">chain.contract</span> <span class="kn">import</span> <span class="n">Contract</span>
<span class="kn">from</span> <span class="nn">chain.database</span> <span class="kn">import</span> <span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span>
<span class="kn">from</span> <span class="nn">chain.database</span> <span class="kn">import</span> <span class="n">IdxTable64</span><span class="p">,</span> <span class="n">IdxTable128</span><span class="p">,</span> <span class="n">Iterator</span>
<span class="kn">from</span> <span class="nn">chain.name</span> <span class="kn">import</span> <span class="n">Name</span>

<span class="nd">@table</span><span class="p">(</span><span class="s2">&quot;mytable&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">a</span><span class="p">:</span> <span class="n">database</span><span class="o">.</span><span class="n">primary</span><span class="p">[</span><span class="n">u64</span><span class="p">]</span>
    <span class="n">b</span><span class="p">:</span> <span class="n">secondary</span><span class="p">[</span><span class="n">u64</span><span class="p">]</span>
    <span class="n">c</span><span class="p">:</span> <span class="n">secondary</span><span class="p">[</span><span class="n">u128</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">u64</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">u64</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">u128</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">primary</span><span class="p">[</span><span class="n">u64</span><span class="p">](</span><span class="n">a</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">secondary</span><span class="p">[</span><span class="n">u64</span><span class="p">](</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">secondary</span><span class="p">[</span><span class="n">u128</span><span class="p">](</span><span class="n">c</span><span class="p">)</span>

<span class="nd">@contract</span><span class="p">(</span><span class="n">main</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyContract</span><span class="p">(</span><span class="n">Contract</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">payer</span> <span class="o">=</span> <span class="n">n</span><span class="s2">&quot;hello&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="n">n</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="n">n</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="n">u64</span><span class="p">,</span> <span class="mi">2</span><span class="n">u64</span><span class="p">,</span> <span class="mi">3</span><span class="n">u128</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">111</span><span class="n">u64</span><span class="p">,</span> <span class="mi">222</span><span class="n">u64</span><span class="p">,</span> <span class="mi">333</span><span class="n">u128</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>

        <span class="n">idx_table_b</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_idx_table_by_b</span><span class="p">()</span>
        <span class="n">it_sec</span> <span class="o">=</span> <span class="n">idx_table_b</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">2</span><span class="n">u64</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;++++++it.primary:&quot;</span><span class="p">,</span> <span class="n">it_sec</span><span class="o">.</span><span class="n">primary</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">it_sec</span><span class="o">.</span><span class="n">primary</span> <span class="o">==</span> <span class="mi">1</span><span class="n">u64</span>

        <span class="n">table</span><span class="o">.</span><span class="n">update_b</span><span class="p">(</span><span class="n">it_sec</span><span class="p">,</span> <span class="mi">22</span><span class="n">u64</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>

        <span class="n">it_sec</span> <span class="o">=</span> <span class="n">idx_table_b</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">22</span><span class="n">u64</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">it_sec</span><span class="o">.</span><span class="n">is_ok</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;++++++it.primary:&quot;</span><span class="p">,</span> <span class="n">it_sec</span><span class="o">.</span><span class="n">primary</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">it_sec</span><span class="o">.</span><span class="n">primary</span> <span class="o">==</span> <span class="mi">1</span><span class="n">u64</span>
</code></pre></div>
<p>Note the following code in the above code:</p>
<div class="highlight"><pre><span></span><code><span class="n">idx_table_b</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_idx_table_by_b</span><span class="p">()</span>
<span class="n">it_sec</span> <span class="o">=</span> <span class="n">idx_table_b</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">2</span><span class="n">u64</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;++++++it.primary:&quot;</span><span class="p">,</span> <span class="n">it_sec</span><span class="o">.</span><span class="n">primary</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">it_sec</span><span class="o">.</span><span class="n">primary</span> <span class="o">==</span> <span class="mi">1</span><span class="n">u64</span>

<span class="n">table</span><span class="o">.</span><span class="n">update_b</span><span class="p">(</span><span class="n">it_sec</span><span class="p">,</span> <span class="mi">22</span><span class="n">u64</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>

<span class="n">it_sec</span> <span class="o">=</span> <span class="n">idx_table_b</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">22</span><span class="n">u64</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">it_sec</span><span class="o">.</span><span class="n">is_ok</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;++++++it.primary:&quot;</span><span class="p">,</span> <span class="n">it_sec</span><span class="o">.</span><span class="n">primary</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">it_sec</span><span class="o">.</span><span class="n">primary</span> <span class="o">==</span> <span class="mi">1</span><span class="n">u64</span>
</code></pre></div>
<p>Brief description of the process:</p>
<ul>
<li><code>it_sec = idx_table_b.find(2u64)</code>: Looks up the value <code>2u64</code> in the binary index and returns the <code>SecondarIterator</code> type result <code>it_sec</code>.</li>
<li><code>table.update_b(it_sec, 22u64, payer)</code>: This line of code implements the update function and updates the value of <code>b</code> to <code>22u64</code>.</li>
<li><code>it_sec = idx_table_b.find(22u64)</code>: Looks up the new binary index.</li>
<li><code>assert assert it_sec.is_ok()</code>: Used to confirm whether the binary index has been updated successfully.</li>
<li><code>assert it_sec.primary == 1u64</code>: Used to confirm whether the primary index is correct.</li>
</ul>
<p>The <code>update_b</code> code is generated by the compiler and is shown below:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">update_b</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">:</span> <span class="n">SecondaryIterator</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">u64</span><span class="p">,</span> <span class="n">payer</span><span class="p">:</span> <span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># 更新`b`的二级索引</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">idx_b</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>
    <span class="c1"># 查找主索引</span>
    <span class="n">it_primary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">primary</span><span class="p">)</span>
    <span class="n">check</span><span class="p">(</span><span class="n">it_primary</span><span class="o">.</span><span class="n">is_ok</span><span class="p">(),</span> <span class="s2">&quot;primary iterator not found&quot;</span><span class="p">)</span>
    <span class="c1"># 获取主索引对应的值</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">A</span> <span class="o">=</span> <span class="n">it_primary</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
    <span class="c1"># 更新主索引对应的值</span>
    <span class="n">value</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">secondary</span><span class="p">[</span><span class="n">u64</span><span class="p">](</span><span class="n">b</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">it_primary</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>
</code></pre></div>
<p>From the code, it is apparent that when updating the binary index, the corresponding value in the primary index will also be updated.</p>
<h2 id="deleting-the-binary-index">Deleting the binary index</h2>
<div class="highlight"><pre><span></span><code><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;testremove&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">payer</span> <span class="o">=</span> <span class="n">n</span><span class="s2">&quot;hello&quot;</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="n">n</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="n">n</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="n">u64</span><span class="p">,</span> <span class="mi">2</span><span class="n">u64</span><span class="p">,</span> <span class="mi">3</span><span class="n">u128</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>

    <span class="n">it</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="n">u64</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>

    <span class="n">idx_table_b</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_idx_table_by_b</span><span class="p">()</span>
    <span class="n">it_sec</span> <span class="o">=</span> <span class="n">idx_table_b</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">2</span><span class="n">u64</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">it_sec</span><span class="o">.</span><span class="n">is_ok</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># test.py</span>
<span class="k">def</span> <span class="nf">test_remove_secondary</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">init_db_test</span><span class="p">(</span><span class="s1">&#39;db_example8&#39;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;testremove&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">t</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;++++++++++</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">])</span>
</code></pre></div>
<p>Compilation:</p>
<div class="highlight"><pre><span></span><code>python-contract<span class="w"> </span>build<span class="w"> </span>db_example/db_example8.codon
</code></pre></div>
<p>Running the test:</p>
<div class="highlight"><pre><span></span><code>ipyeos<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>-s<span class="w"> </span>-x<span class="w"> </span>test.py<span class="w"> </span>-k<span class="w"> </span>test_remove_secondary
</code></pre></div>
<h2 id="using-the-api-to-perform-secondary-index-queries-on-a-table">Using the API to perform secondary index queries on a table</h2>
<p>In the <code>db_example8.codon</code> example, two binary indexes are defined, with the types <code>u64</code> and <code>u128</code>, respectively. The <code>get_table_rows</code> API also supports finding corresponding values through binary indexes.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_example9</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">init_db_test</span><span class="p">(</span><span class="s1">&#39;db_example8&#39;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">t</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;++++++++++</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">])</span>

    <span class="c1"># find by secondary u64</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get_table_rows</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;mytable&#39;</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;i64&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;++++++++++</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">22</span>

    <span class="c1"># find by secondary u128</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get_table_rows</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;mytable&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;i128&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;++++++++++</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span>
</code></pre></div>
<p>Explanation of the code below:</p>
<p>To find the value in the table through the second index <code>b</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">rows</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get_table_rows</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;mytable&#39;</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;i64&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Here, <code>i64</code> is the index type of <code>b</code>, and <code>2</code> is zero-based index corresponding to the index.</p>
<p>To find the value in the table through the second index <code>c</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">rows</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get_table_rows</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;mytable&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;i128&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Here, <code>i128</code> is the index type of <code>c</code>. Note that the value <code>3</code> in the <code>lowerbound</code> parameter is the value of the binary index. Since <code>u128</code> has exceeded the range of 64-bit integers, a numeric string is used to represent it. Finally, the last parameter <code>3</code> is the corresponding index number.</p>
<p>The results of running the above test code are as follows:</p>
<div class="highlight"><pre><span></span><code>++++++++++[{&#39;a&#39;: 1, &#39;b&#39;: 22, &#39;c&#39;: &#39;3&#39;}, {&#39;a&#39;: 111, &#39;b&#39;: 222, &#39;c&#39;: &#39;333&#39;}]
++++++++++[{&#39;a&#39;: 1, &#39;b&#39;: 22, &#39;c&#39;: &#39;3&#39;}, {&#39;a&#39;: 111, &#39;b&#39;: 222, &#39;c&#39;: &#39;333&#39;}]
</code></pre></div>
<h2 id="implementation-principles-of-the-database">Implementation principles of the database</h2>
<p>The above code demonstrates the basic operations of the database. However, during the compilation process, some methods and classes are generated by the compiler. The following code displays the code generated by the compiler.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># db_example6.codon</span>
<span class="kn">from</span> <span class="nn">chain.contract</span> <span class="kn">import</span> <span class="n">Contract</span>
<span class="kn">from</span> <span class="nn">chain.database</span> <span class="kn">import</span> <span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span>
<span class="kn">from</span> <span class="nn">chain.database</span> <span class="kn">import</span> <span class="n">IdxTable64</span><span class="p">,</span> <span class="n">IdxTable128</span><span class="p">,</span> <span class="n">Iterator</span>
<span class="kn">from</span> <span class="nn">chain.mi</span> <span class="kn">import</span> <span class="n">MultiIndexBase</span>
<span class="kn">from</span> <span class="nn">chain.name</span> <span class="kn">import</span> <span class="n">Name</span>

<span class="nd">@packer</span>
<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">a</span><span class="p">:</span> <span class="n">database</span><span class="o">.</span><span class="n">primary</span><span class="p">[</span><span class="n">u64</span><span class="p">]</span>
    <span class="n">b</span><span class="p">:</span> <span class="n">secondary</span><span class="p">[</span><span class="n">u64</span><span class="p">]</span>
    <span class="n">c</span><span class="p">:</span> <span class="n">secondary</span><span class="p">[</span><span class="n">u128</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">u64</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">u64</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">u128</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">primary</span><span class="p">[</span><span class="n">u64</span><span class="p">](</span><span class="n">a</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">secondary</span><span class="p">[</span><span class="n">u64</span><span class="p">](</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">secondary</span><span class="p">[</span><span class="n">u128</span><span class="p">](</span><span class="n">c</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_primary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">u64</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">MultiIndexA</span><span class="p">(</span><span class="n">MultiIndexBase</span><span class="p">[</span><span class="n">A</span><span class="p">]):</span>
    <span class="n">idx_b</span><span class="p">:</span> <span class="n">IdxTable64</span>
    <span class="n">idx_c</span><span class="p">:</span> <span class="n">IdxTable128</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="n">Name</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">Name</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">Name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
        <span class="n">idx_table_base</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xfffffffffffffff0</span><span class="n">u64</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_b</span> <span class="o">=</span> <span class="n">IdxTable64</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">Name</span><span class="p">(</span><span class="n">idx_table_base</span> <span class="o">|</span> <span class="n">u64</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_c</span> <span class="o">=</span> <span class="n">IdxTable128</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">Name</span><span class="p">(</span><span class="n">idx_table_base</span> <span class="o">|</span> <span class="n">u64</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">A</span><span class="p">,</span> <span class="n">payer</span><span class="p">:</span> <span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">A</span><span class="p">]:</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">u64</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get_primary</span><span class="p">()</span>
        <span class="n">it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_b</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">b</span><span class="p">(),</span> <span class="n">payer</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">idx_c</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">c</span><span class="p">(),</span> <span class="n">payer</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">it</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">A</span><span class="p">],</span> <span class="n">item</span><span class="p">:</span> <span class="n">A</span><span class="p">,</span> <span class="n">payer</span><span class="p">:</span> <span class="n">Name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>

        <span class="n">primary</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get_primary</span><span class="p">()</span>
        <span class="n">secondary</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">b</span><span class="p">()</span>
        <span class="n">it_secondary</span><span class="p">,</span> <span class="n">old_secondary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_b</span><span class="o">.</span><span class="n">find_by_primary</span><span class="p">(</span><span class="n">primary</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">secondary</span> <span class="o">==</span> <span class="n">old_secondary</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">idx_b</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">it_secondary</span><span class="p">,</span> <span class="n">secondary</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>

        <span class="n">secondary</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">c</span><span class="p">()</span>
        <span class="n">it_secondary</span><span class="p">,</span> <span class="n">old_secondary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_c</span><span class="o">.</span><span class="n">find_by_primary</span><span class="p">(</span><span class="n">primary</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">secondary</span> <span class="o">==</span> <span class="n">old_secondary</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">idx_c</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">it_secondary</span><span class="p">,</span> <span class="n">secondary</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">A</span><span class="p">]):</span>
        <span class="n">sec_it</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_b</span><span class="o">.</span><span class="n">find_by_primary</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get_primary</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_b</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">sec_it</span><span class="p">)</span>

        <span class="n">sec_it</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_c</span><span class="o">.</span><span class="n">find_by_primary</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get_primary</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_c</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">sec_it</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primary</span><span class="p">:</span> <span class="n">u64</span><span class="p">):</span>
        <span class="n">it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">primary</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">it</span><span class="o">.</span><span class="n">is_ok</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_idx_table_by_b</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IdxTable64</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_b</span>

    <span class="k">def</span> <span class="nf">get_idx_table_by_c</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IdxTable128</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_c</span>

    <span class="k">def</span> <span class="nf">update_b</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">:</span> <span class="n">SecondaryIterator</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">u64</span><span class="p">,</span> <span class="n">payer</span><span class="p">:</span> <span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_b</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>
        <span class="n">it_primary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">primary</span><span class="p">)</span>
        <span class="n">check</span><span class="p">(</span><span class="n">it_primary</span><span class="o">.</span><span class="n">is_ok</span><span class="p">(),</span> <span class="s2">&quot;primary iterator not found&quot;</span><span class="p">)</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">A</span> <span class="o">=</span> <span class="n">it_primary</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">value</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">secondary</span><span class="p">[</span><span class="n">u64</span><span class="p">](</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">it_primary</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_c</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">:</span> <span class="n">SecondaryIterator</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">u128</span><span class="p">,</span> <span class="n">payer</span><span class="p">:</span> <span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_c</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>
        <span class="n">it_primary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">primary</span><span class="p">)</span>
        <span class="n">check</span><span class="p">(</span><span class="n">it_primary</span><span class="o">.</span><span class="n">is_ok</span><span class="p">(),</span> <span class="s2">&quot;primary iterator not found&quot;</span><span class="p">)</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">A</span> <span class="o">=</span> <span class="n">it_primary</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">value</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">secondary</span><span class="p">[</span><span class="n">u128</span><span class="p">](</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">it_primary</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>

<span class="nd">@extend</span>
<span class="k">class</span> <span class="nc">A</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">new_table</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="n">Name</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">Name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MultiIndexA</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">n</span><span class="s2">&quot;mytable&quot;</span><span class="p">)</span>

<span class="nd">@contract</span><span class="p">(</span><span class="n">main</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyContract</span><span class="p">(</span><span class="n">Contract</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">payer</span> <span class="o">=</span> <span class="n">n</span><span class="s2">&quot;hello&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="n">n</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="n">n</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="n">u64</span><span class="p">,</span> <span class="mi">2</span><span class="n">u64</span><span class="p">,</span> <span class="mi">3</span><span class="n">u128</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">payer</span><span class="p">)</span>

        <span class="n">idx_table_b</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_idx_table_by_b</span><span class="p">()</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">idx_table_b</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">2</span><span class="n">u64</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;++++++it.primary:&quot;</span><span class="p">,</span> <span class="n">it</span><span class="o">.</span><span class="n">primary</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">it</span><span class="o">.</span><span class="n">primary</span> <span class="o">==</span> <span class="mi">1</span><span class="n">u64</span>

        <span class="n">idx_table_c</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_idx_table_by_c</span><span class="p">()</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">idx_table_c</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">3</span><span class="n">u128</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;++++++it.primary:&quot;</span><span class="p">,</span> <span class="n">it</span><span class="o">.</span><span class="n">primary</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">it</span><span class="o">.</span><span class="n">primary</span> <span class="o">==</span> <span class="mi">1</span><span class="n">u64</span>
</code></pre></div>
<p>This example demonstrates a scenario where there are two binary indexes. Only the name <code>table</code> was changed to <code>packer</code>. In this case, the compiler will not generate any code related to the database.</p>
<p>By comparison, it is apparent that the compiler generates a class named <code>MultiIndexA</code>, which inherits from the <code>MultiIndexBase</code> class defined in <code>mi.codon</code>. This class has the following methods:</p>
<ul>
<li>def store(self, item: A, payer: Name) -&gt; Iterator[A]</li>
<li>def update(self, it: Iterator[A], item: A, payer: Name)</li>
<li>def remove(self, it: Iterator[A])</li>
<li>def get_idx_table_by_b(self) -&gt; IdxTable64:</li>
<li>def get_idx_table_by_c(self) -&gt; IdxTable128:</li>
<li>def update_b(self, it: SecondaryIterator, b: u64, payer: Name) -&gt; None:</li>
<li>def update_c(self, it: SecondaryIterator, c: u128, payer: Name) -&gt; None:</li>
</ul>
<p>In addition, the class <code>A</code> is generated, along with the following additional methods:</p>
<ul>
<li><code>get_primary</code>: retrieves the primary index</li>
<li><code>get_idx_table_by_b</code>: retrieves the table indexed by <code>b</code>, returning an instance of the <code>IdxTable64</code> class</li>
<li><code>get_idx_table_by_c</code>: retrieves the table indexed by <code>c</code>, returning an instance of the <code>IdxTable128</code> class</li>
<li><code>new_table</code></li>
</ul>
<p>Test code:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_example6</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">init_db_test</span><span class="p">(</span><span class="s1">&#39;db_example6&#39;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">t</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;++++++++++</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">])</span>
</code></pre></div>
<p>Compilation:</p>
<div class="highlight"><pre><span></span><code>python-contract build db_example/db_example6.codon
</code></pre></div>
<p>Running the test:</p>
<div class="highlight"><pre><span></span><code>ipyeos<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>-s<span class="w"> </span>-x<span class="w"> </span>test.py<span class="w"> </span>-k<span class="w"> </span>test_example6
</code></pre></div>
<p>Output:</p>
<div class="highlight"><pre><span></span><code>++++++it.primary: 1
++++++it.primary: 1
</code></pre></div>
<h2 id="summary">Summary</h2>
<p>The data storage functionality in EOS is relatively comprehensive, and the second-level index table function makes data querying very flexible. This chapter provides a detailed explanation of the code for table operations, including adding, deleting, modifying, and querying. This chapter contains a lot of content and requires some time to digest. You can try to modify the examples and run them to gain a better understanding of the content covered in this chapter.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.19047be9.min.js"></script>
      
    
  
<script>
console.log("hello, plugin")
var mkdocs_chat_plugin = {'param': '', 'docs_chat_endpoint': 'https://docs.uuos.io:8443/chat'};
</script>
<script src="../js/chat-dialog-plugin.js"></script>

        </body>
</html>